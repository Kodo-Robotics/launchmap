tests:
  - name: opaque_function_tracks_variables
    description: Captures variables from LaunchConfiguration().perform(context)
    input: |
      from launch import LaunchDescription
      from launch.actions import DeclareLaunchArgument, OpaqueFunction
      from launch.substitutions import LaunchConfiguration
      from launch_ros.actions import Node

      def launch_setup(context, *args, **kwargs):
          name = LaunchConfiguration("robot_name").perform(context)
          return [Node(package='demo', executable='talker', name=name)]

      def generate_launch_description():
          return LaunchDescription([
              DeclareLaunchArgument("robot_name", default_value="robot_1"),
              OpaqueFunction(function=launch_setup)
          ])
    expected:
      arguments:
        - name: robot_name
          default_value: robot_1
      opaque_functions:
        - name: launch_setup
          returns:
            nodes:
              - package: demo
                executable: talker
                name: ${LaunchConfiguration:robot_name}
      launch_argument_usages:
        - argument: robot_name
          path: opaque_functions[0].returns.nodes[0].name
      undeclared_launch_configurations: []

  - name: opaque_function_variable_with_transformation
    description: Tracks transformed variable from LaunchConfiguration
    input: |
      from launch import LaunchDescription
      from launch.actions import DeclareLaunchArgument, OpaqueFunction
      from launch.substitutions import LaunchConfiguration
      from launch_ros.actions import Node

      def launch_setup(context, *args, **kwargs):
          flag_str = LaunchConfiguration("flag").perform(context)
          flag = flag_str.lower() in ["true", "1"]
          return [Node(package="demo", executable="flagger", parameters=[{"enabled": flag}])]
      
      def generate_launch_description():
          return LaunchDescription([
              DeclareLaunchArgument("flag", default_value="false"),
              OpaqueFunction(function=launch_setup)
          ])
    expected:
      arguments:
        - name: flag
          default_value: false
      opaque_functions:
        - name: launch_setup
          returns:
            nodes:
              - package: demo
                executable: flagger
                parameters:
                  - enabled: ${LaunchConfiguration:flag}.lower().in(['true', '1'])
      launch_argument_usages:
        - argument: flag
          path: opaque_functions[0].returns.nodes[0].parameters[0].enabled
      undeclared_launch_configurations: []

  - name: opaque_function_unused_variable
    description: Detects when a LaunchConfiguration derived variable is unused
    input: |
      from launch import LaunchDescription
      from launch.actions import DeclareLaunchArgument, OpaqueFunction
      from launch.substitutions import LaunchConfiguration
      from launch_ros.actions import Node

      def launch_setup(context, *args, **kwargs):
          robot_name = LaunchConfiguration("robot_name").perform(context)
          debug_mode = LaunchConfiguration("debug").perform(context)
          return [Node(package="demo", executable="talker", name=robot_name)]
      
      def generate_launch_description():
          return LaunchDescription([
              DeclareLaunchArgument("robot_name", default_value="robot_1"),
              DeclareLaunchArgument("debug", default_value="false"),
              OpaqueFunction(function=launch_setup)
          ])
    expected:
      arguments:
        - name: robot_name
          default_value: robot_1
        - name: debug
          default_value: false
      opaque_functions:
        - name: launch_setup
          returns:
            nodes:
              - package: demo
                executable: talker
                name: ${LaunchConfiguration:robot_name}
      launch_argument_usages:
        - argument: robot_name
          path: opaque_functions[0].returns.nodes[0].name
      undeclared_launch_configurations: []